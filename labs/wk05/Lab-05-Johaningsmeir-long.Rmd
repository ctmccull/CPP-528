---
title: "Lab 05"
author: "Sarah Johaningsmeir"
date: '2022-04-16'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, warning=FALSE, message=FALSE}

library( tidyverse )
library( stargazer )
library( dplyr )
library( here )
library( knitr )
library( pander )
library( scales )

# set randomization seed ----
set.seed( 1234 )


```


```{r, results = 'asis'}

# load necessary functions and objects ----
# note: all of these are R objects that will be used throughout this .rmd file
import::here("S_TYPE",
             "d",
             "df",
             "d3",
             "d6",
             "PLOTS",
             "%>%",
             # notice the use of here::here() that points to the .R file
             # where all these R objects are created
             .from = here::here("labs/wk05/lab_05_source.R"),
             .character_only = TRUE)

```



```{r, results = 'asis'}

# show summary statistics
stargazer::stargazer( df, 
                      type="html", 
                      digits=0, 
                      summary.stat = c("min", "p25","median","mean","p75","max") )

```


### Program Participation Criteria

```{r}

### POVERTY RATES
gridExtra::grid.arrange( PLOTS$pov_rate_2000$nmtc, 
                         PLOTS$pov_rate_2000$lihtc, 
                         nrow = 1 )

```




```{r}

### HOME VALUES
gridExtra::grid.arrange( PLOTS$mhv_2000$nmtc, 
                         PLOTS$mhv_2000$lihtc, 
                         nrow = 1 )

```


## Household Income in 2000

```{r}

### HOUSEHOLD INCOME COMPARISONIN 2000:
### PROGRAM RECIPIENTS VS NON-RECIPIENT TRACTS

# Tracts that received LIHTC
mean( d$hinc00[ d$num.lihtc > 0 ] )

```

```{r}

# Tracts that did not receive LIHTC
mean( d$hinc00[ d$num.lihtc == 0 ] )

```

```{r}

# Tracts that received NMTC
mean( d$hinc00[ d$num.nmtc > 0 ] )

```

```{r}

# Tracts that did not receive NMTC
mean( d$hinc00[ d$num.nmtc == 0 ] )

```


### Home Values in 2000

```{r}

### MEDIAN HOME VALUE COMPARISON IN 2000

# Tracts that received LIHTC
mean( d$mhv.00[ d$num.lihtc > 0 ], na.rm=T )

```


```{r}

# Tracts that did not receive LIHTC
mean( d$mhv.00[ d$num.lihtc == 0 ], na.rm=T )

```


```{r}

# Tracts that received NMTC
mean( d$mhv.00[ d$num.nmtc > 0 ], na.rm=T )

```


```{r}

# Tracts that did not receive NMTC
mean( d$mhv.00[ d$num.nmtc == 0 ], na.rm=T )

```


### Poverty Rates 2000

```{r}

### POVERTY RATE COMPARISONS

# Tracts that received LIHTC
summary( d$pov.rate.00[ d$num.lihtc > 0 ] )

```

```{r}

# Tracts that did not receive LIHTC
summary( d$pov.rate.00[ d$num.lihtc == 0 ] )

```


```{r}

# Tracts that received NMTC
summary( d$pov.rate.00[ d$num.nmtc > 0 ] )

```

```{r}

# Tracts that did not 
summary( d$pov.rate.00[ d$num.nmtc == 0 ] )

```


```{r}

### MHV Growth Rates (DV in Model)
gridExtra::grid.arrange( PLOTS$mhv_growth$lihtc, 
                         PLOTS$mhv_growth$nmtc, 
                         nrow = 1 )

```


### Home value growth rates

```{r}

# Tracts that received LIHTC
summary( d$growth[ d$num.lihtc > 0 ] )

```


```{r}

# Tracts that did not receive LIHTC
summary( d$growth[ d$num.lihtc == 0 ] )

```


```{r}

# Tracts that received NMTC
summary( d$growth[ d$num.nmtc > 0 ] )

```


```{r}

# Tracts that did not receive NMTC
summary( d$growth[ d$num.nmtc == 0 ] )

```


## Difference-in-difference Model

```{r, results = 'asis'}

# create the difference in difference model
# note: treat = B1, post = B2, treat*post = B3
m <- lm( y ~ treat.nmtc + post + treat.nmtc*post, data=d3 )

# display model results
stargazer::stargazer(m,
                     type = "html",
                     digits = 2)

```

### Exponentiate coefficients to recover the mean:

```{r}

b0 <- m$coefficients[1] 
b1 <- m$coefficients[2]
b2 <- m$coefficients[3]
b3 <- m$coefficients[4]

# C1 = B0  
exp( b0 )

```

```{r}

# C2 = B0 + B2 
exp( b0 + b2 )

```


```{r}

# T1 = B0 + B1 
exp( b0 + b1 )

```


```{r}

# T2 = B0 + B1 + B2 + B3 
exp( b0+b1+b2+b3 )

```


## Model from Lab 04


```{r}

d.reg <- d

d.reg$mhv.change[ d.reg$mhv.change > 200 ] <- NA
d.reg$p.white <- log10( d.reg$p.white.00 + 1 )
d.reg$p.col <- log10( d.reg$p.col.edu.00 + 1 )
d.reg$pov.rate <- log10( d.reg$pov.rate.00 + 1 )

# average growth in median home value for the city
d.reg <- 
  d.reg %>%
  group_by( cbsaname ) %>%
  mutate( metro.mhv.growth = 100 * median( mhv.change, na.rm=T ) ) %>%
  ungroup() 


```



```{r, results='asis'}

m1 <- lm( mhv.change ~ p.white + cbsa, data = d.reg )
m2 <- lm( mhv.change ~ p.col + cbsa, data = d.reg )
m3 <- lm( mhv.change ~ pov.rate + cbsa, data = d.reg )

stargazer( m1, m2, m3,
           type = "html", digits = 2,
           omit.stat = c( "rsq", "f" ),
           omit = "cbsa" )

```

## Difference in Difference Regression for NMTC

```{r, results = 'asis'}

m.nmtc <- lm( y ~ treat.nmtc + post + treat.nmtc * post, data = d3 )

stargazer::stargazer(m.nmtc,
                     type = "html",
                     digits = 2 )

```


```{r}

b0 <- m.nmtc$coefficients[1] 
b1 <- m.nmtc$coefficients[2]
b2 <- m.nmtc$coefficients[3]
b3 <- m.nmtc$coefficients[4]

# C1 = B0  
exp( b0 )

```


```{r}

# C2 = B0 + B2 
exp( b0 + b2 )

```

```{r}

# T1 = B0 + B1 
exp( b0 + b1 )

```

```{r}

# T2 = B0 + B1 + B2 + B3 
exp( b0+b1+b2+b3 )

```
### NMTC results without including control variables

C1 = 156581.4
C2 = 196984.4
T1 = 120265.3
T2 = 166560.5 

In this model without any control variables added, New Market Tax Credit investments 
had a significant effect on median home values, with the value of homes in tracts 
that received NMTC investments increasing less than those in tracts without NMTC.
The median house value was $5892.20 less in 2010 data than would be expected if 
NMTC investments were not made. 
However, because NMTC are only allowed in tracts identified because of poverty or
low family incomes, this finding seems likely to be the result of confounding
variables such as poverty.


## Adding control variables to NMTC analysis

Variables of interest:

* Percent white residents in 2000 (p.white.00)
* Percent with 4-year college education or more (p.col.edu.00)
* Poverty rate in 2000 (pov.rate.00)

```{r, results = 'asis'}

m.nmtc.controls <- lm( y ~ treat.nmtc + post +treat.nmtc * post + p.white + 
                         p.col.edu.00 + pov.rate.00, data = d3 )

stargazer::stargazer(m.nmtc.controls,
                     type = "html",
                     digits = 2 )

```


```{r}

b0.nmtc <- m.nmtc.controls$coefficients[1] 
b1.nmtc <- m.nmtc.controls$coefficients[2]
b2.nmtc <- m.nmtc.controls$coefficients[3]
b3.nmtc <- m.nmtc.controls$coefficients[4]

# C1 = B0  
exp( b0.nmtc )

# C2 = B0 + B2 
exp( b0.nmtc + b2.nmtc )

# T1 = B0 + B1 
exp( b0 + b1 )

# T2 = B0 + B1 + B2 + B3 
exp( b0+b1+b2+b3 )


```

Explanation:
When percent white residents, percent of college educated residents, and poverty 
rate in 2000 are included as controls, New Market Tax Credits had a significant
effect on median home value. New Market Tax Credits accounted for a $7681.60 increase
to median home value of $166,560.50, an increase of $7681 over the expected value
if New Market Tax Credits had not been utilized.



## Difference in Difference Regression for LIHTC without controls

```{r, results = 'asis'}

m.lihtc <- lm( y ~ treat.lihtc + post + treat.lihtc * post, data = d6 )

stargazer::stargazer(m.lihtc,
                     type = "html",
                     digits = 2 )

```


```{r}

b0 <- m.lihtc$coefficients[1] 
b1 <- m.lihtc$coefficients[2]
b2 <- m.lihtc$coefficients[3]
b3 <- m.lihtc$coefficients[4]

# C1 = B0  
exp( b0 )

# C2 = B0 + B2 
exp( b0 + b2 )

# T1 = B0 + B1 
exp( b0 + b1 )

# T2 = B0 + B1 + B2 + B3 
exp( b0+b1+b2+b3 )

```
### LIHTC model without controlling for any other variables 

In this model, which does not include any control variables, the Low Income Housing
Tax Credit program did not have a signficant effect on median home values.


### Adding control variables to LITC analysis

Variables of interest:

* Percent white residents in 2000 (p.white.00)
* Percent with 4-year college education or more (p.col.edu.00)
* Poverty rate in 2000 (pov.rate.00)


```{r, results = 'asis'}

m.lihtc.controls <- lm( y ~ treat.lihtc + post +treat.lihtc * post + p.white + 
                         p.col.edu.00 + pov.rate.00, data = d6 )

stargazer::stargazer(m.lihtc.controls,
                     type = "html",
                     digits = 2 )


```

```{r}

b0 <- m.lihtc.controls$coefficients[1] 
b1 <- m.lihtc.controls$coefficients[2]
b2 <- m.lihtc.controls$coefficients[3]
b3 <- m.lihtc.controls$coefficients[4]

# C1 = B0  
exp( b0 )

# C2 = B0 + B2 
exp( b0 + b2 )

# T1 = B0 + B1 
exp( b0 + b1 )

# T2 = B0 + B1 + B2 + B3 
exp( b0+b1+b2+b3 )


```
### LIHTC Model with controls

Interpretation:
When percent white residents, percent of college educated residents, and poverty 
rate in 2000 are included as controls, Low Income Housing Tax Credits did not have
a significant effect on median home values. In this model, median home price is
nearly identical in tracts with or without LIHTC. 


## Reflection

**How can we test the parallel lines assumption in this model?**

If possible, examining longitudinal data, from points before and/or after the timeframe in question would provide evidence that the parallel trends assumption is met, that both the treatment and control groups would have changed at the same rate in the absence of the treatment. 

